---
- name: Restart mysql
  service:
    name: mysql
    state: restarted
- name: Restart prometheus-mysqld-exporter
  service:
    name: prometheus-mysqld-exporter
    state: restarted

- name: Reset MySQL source
  community.mysql.mysql_replication:
    mode: "{{ item }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  loop:
    - stopreplica
    - resetprimary
  when: inventory_hostname == mysql_host

- name: Reset MySQL replica
  community.mysql.mysql_replication:
    mode: "{{ item }}"
    primary_host: "{{ mysql_host }}"
    primary_user: "{{ mysql_replication_login }}"
    primary_password: "{{ mysql_replication_password }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
  loop:
    - stopreplica
    - changeprimary
    - resetreplica
    - startreplica
  when: inventory_hostname != mysql_host



  # stop replica;
  # change replication soruce to source_host='hudolejev-2', sourse_user='replication', sourse_password='mypass';
  # reset replica;
  # start replica;
  # show replica status\G
  # Last_IO_Errno Last_SQL_error
  # mysql -h hudolejev-2 -u replication -p
